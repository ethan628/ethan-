import React, { useState, useEffect, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI, Chat } from '@google/genai';
import './index.css';

// èŠå¤©è¨Šæ¯çš„å‹åˆ¥å®šç¾©
interface ChatMessage {
  role: 'user' | 'model';
  text: string;
}

// å¤©æ°£è­¦å ±çš„å‹åˆ¥å®šç¾©
interface WeatherAlert {
  headline: string;
  description: string;
}

// å¤©æ°£è³‡æ–™çš„å‹åˆ¥å®šç¾©
interface WeatherData {
  city: string;
  current: {
    temp_c: number;
    condition: string;
    humidity: number;
    wind_kph: number;
    feelslike_c: number;
    uv: number;
    wind_dir: string;
  };
  forecast: {
    date: string;
    day: {
      maxtemp_c: number;
      mintemp_c: number;
      condition: string;
      daily_chance_of_rain: number;
      daily_rainfall_mm: number;
      rain_ph: number;
      daily_uv_index: number;
    };
  }[];
  alerts: WeatherAlert[];
}

// è©³ç´°è³‡æ–™çš„å‹åˆ¥å®šç¾©
interface DetailedData {
  city: string;
  dailyData: {
    date: string;
    rainfall_mm: number;
    rain_ph: number | null;
    uv_index: number;
  }[];
}

// ç©ºæ°£å“è³ªè³‡æ–™çš„å‹åˆ¥å®šç¾©
interface AirQualityData {
  city: string;
  aqi: number;
  level: string;
  pollutants: {
    pm25: number;
    pm10: number;
    o3: number;
    no2: number;
    so2: number;
    co: number;
  };
  health_recommendation: string;
}

// é¢±é¢¨è³‡è¨Šçš„å‹åˆ¥å®šç¾©
interface TyphoonInfo {
  name: string;
  englishName: string;
  isActive: boolean;
  location: string;
  maxWindSpeed_kph: number;
  stormRadius_km: number;
  movement: string;
  summary: string;
}

interface GroundingChunk {
  web?: {
    uri?: string;
    title?: string;
  };
}


const navItems = ['å¤©æ°£', 'ç©ºæ°£å“è³ª', 'ç”Ÿæ´»', 'åœ°éœ‡', 'é¢±é¢¨å‹•æ…‹', 'æµ·è±¡', 'æ°£å€™', 'è³‡æ–™', 'çŸ¥è­˜èˆ‡å¤©æ–‡'];

const lifeCategories = [
  { name: 'ä¼‘é–’æ—…éŠ', icon: 'ğŸï¸' }, { name: 'å–®è»Š', icon: 'ğŸš²' },
  { name: 'æºªæµ', icon: 'ğŸ’§' }, { name: 'ç™»å±±', icon: 'â›°ï¸' },
  { name: 'è§€æ˜Ÿ', icon: 'ğŸ”­' }, { name: 'æ©Ÿå ´', icon: 'âœˆï¸' },
  { name: 'æ£’çƒå ´', icon: 'âš¾' }, { name: 'åœ‹å®¶å…¬åœ’', icon: 'ğŸï¸' },
  { name: 'åœ‹å®¶é¢¨æ™¯å€', icon: 'ğŸ–¼ï¸' }, { name: 'åœ‹å®¶æ£®æ—éŠæ¨‚å€', icon: 'ğŸŒ²' },
  { name: 'è¾²å ´æ—…éŠ', icon: 'ğŸ§‘â€ğŸŒ¾' }, { name: 'ä¸»è¦æ°´åº«', icon: 'ğŸ’§' },
  { name: 'è¦ªæµ·æ—…éŠ', icon: 'ğŸ–ï¸' }, { name: 'æµ·æ°´æµ´å ´', icon: 'ğŸŒŠ' },
  { name: 'ä¸»è¦æ¸¯å£', icon: 'âš“' }, { name: 'ä¼‘é–’æ¼æ¸¯', icon: 'ğŸ£' },
  { name: 'æµ·é‡£', icon: 'ğŸ ' }, { name: 'è¡æµª', icon: 'ğŸ„' },
  { name: 'æµ®æ½›', icon: 'ğŸ¤¿' }, { name: 'å®¢åº„æ°£è±¡', icon: 'ğŸ˜ï¸' },
  { name: 'åŸé„‰éƒ¨è½', icon: 'ğŸ›–' }, { name: 'å—å€æ°£è±¡æœå‹™', icon: 'ğŸ§­' },
  { name: 'è¾²æ¥­', icon: 'ğŸŒ¾' }, { name: 'æ¼æ¥­', icon: 'ğŸŸ' },
  { name: 'æ‰“å¡å ±å¤©æ°£', icon: 'ğŸ“¸' }, { name: 'æ°£è±¡éš¨é¸å¹³å°', icon: 'ğŸŒ' },
  { name: 'å¥åº·æ°£è±¡', icon: 'â¤ï¸' }
];

const earthquakeCategories = [
  { name: 'è¿‘åœ°éœ‡', icon: 'ğŸŒ' },
  { name: 'å…¨çƒåœ°éœ‡', icon: 'ğŸŒ' },
  { name: 'åœ°éœ‡æ´»å‹•å½™æ•´', icon: 'ğŸ“Š' },
  { name: 'åœ°éœ‡ç™¾å•', icon: 'â“' },
  { name: 'åœ°éœ‡é˜²è­·', icon: 'ğŸ›¡ï¸' },
  { name: 'åœ°éœ‡è§€æ¸¬ç¶²', icon: 'ğŸ“¡' },
  { name: 'ç½å®³åœ°éœ‡', icon: 'ğŸšï¸' },
  { name: 'åœ°éœ‡è©±é¡Œ', icon: 'ğŸ—£ï¸' }
];

const App: React.FC = () => {
  const [city, setCity] = useState<string>('å°åŒ—');
  const [weatherData, setWeatherData] = useState<WeatherData | null>(null);
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<string>('å¤©æ°£');

  const [astroFact, setAstroFact] = useState<string>('');
  const [astroLoading, setAstroLoading] = useState<boolean>(false);
  const [astroError, setAstroError] = useState<string | null>(null);

  const [detailedData, setDetailedData] = useState<DetailedData | null>(null);
  const [dataLoading, setDataLoading] = useState<boolean>(false);
  const [dataError, setDataError] = useState<string | null>(null);
  
  const [airQualityData, setAirQualityData] = useState<AirQualityData | null>(null);
  const [airQualityLoading, setAirQualityLoading] = useState<boolean>(false);
  const [airQualityError, setAirQualityError] = useState<string | null>(null);

  const [isLifeModalOpen, setIsLifeModalOpen] = useState<boolean>(false);
  const [selectedLifeCategory, setSelectedLifeCategory] = useState<string>('');
  const [lifeData, setLifeData] = useState<string>('');
  const [lifeLoading, setLifeLoading] = useState<boolean>(false);
  const [lifeError, setLifeError] = useState<string | null>(null);

  const [isEarthquakeModalOpen, setIsEarthquakeModalOpen] = useState<boolean>(false);
  const [selectedEarthquakeCategory, setSelectedEarthquakeCategory] = useState<string>('');
  const [earthquakeData, setEarthquakeData] = useState<string>('');
  const [earthquakeLoading, setEarthquakeLoading] = useState<boolean>(false);
  const [earthquakeError, setEarthquakeError] = useState<string | null>(null);

  const [typhoonData, setTyphoonData] = useState<TyphoonInfo[] | null>(null);
  const [typhoonLoading, setTyphoonLoading] = useState<boolean>(false);
  const [typhoonError, setTyphoonError] = useState<string | null>(null);
  const [typhoonSources, setTyphoonSources] = useState<GroundingChunk[]>([]);

  // AI Chat State
  const [isChatOpen, setIsChatOpen] = useState<boolean>(false);
  const [chatHistory, setChatHistory] = useState<ChatMessage[]>([]);
  const [chatInput, setChatInput] = useState<string>('');
  const [isChatLoading, setIsChatLoading] = useState<boolean>(false);
  const [chatSession, setChatSession] = useState<Chat | null>(null);
  const chatMessagesRef = useRef<HTMLDivElement>(null);


  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY! });

  useEffect(() => {
    // Initialize Chat Session
    const initChat = () => {
      const session = ai.chats.create({
        model: 'gemini-2.5-flash-preview-04-17',
        config: {
          systemInstruction: 'ä½ æ˜¯ä¸€å€‹å…¨èƒ½çš„æ°£è±¡èˆ‡ç”Ÿæ´»åŠ©ç†ã€‚è«‹å„ªå…ˆä½¿ç”¨å°ç£ä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™ä¾†å›ç­”å•é¡Œã€‚æ‰€æœ‰å›ç­”éƒ½å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚',
        },
      });
      setChatSession(session);
      setChatHistory([
        { role: 'model', text: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AI å°å¹«æ‰‹ï¼Œæœ‰ä»€éº¼æ°£è±¡æˆ–ç”Ÿæ´»ç›¸é—œçš„å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼' }
      ]);
    };
    initChat();
  }, []);

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!chatInput.trim() || !chatSession || isChatLoading) return;
  
    const userMessage: ChatMessage = { role: 'user', text: chatInput };
    setChatHistory(prev => [...prev, userMessage]);
    setChatInput('');
    setIsChatLoading(true);
  
    try {
      const response = await chatSession.sendMessage({ message: userMessage.text });
      const modelMessage: ChatMessage = { role: 'model', text: response.text };
      setChatHistory(prev => [...prev, modelMessage]);
    } catch (e) {
      console.error('Chat API éŒ¯èª¤:', e);
      const errorMessage: ChatMessage = { role: 'model', text: 'æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚' };
      setChatHistory(prev => [...prev, errorMessage]);
    } finally {
      setIsChatLoading(false);
    }
  };

  useEffect(() => {
    if (chatMessagesRef.current) {
      chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
    }
  }, [chatHistory, isChatLoading]);

  const getWeatherData = async () => {
    if (!city) {
      setError('è«‹è¼¸å…¥åŸå¸‚åç¨±ã€‚');
      return;
    }
    setLoading(true);
    setError(null);
    setWeatherData(null);

    const prompt = `
      æ ¹æ“šå°ç£ä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™ï¼Œæä¾› ${city} çš„è©³ç´°å³æ™‚å¤©æ°£ã€5 å¤©å¤©æ°£é å ±ï¼Œä»¥åŠä»»ä½•æœ‰æ•ˆçš„å¤©æ°£è­¦å ±ã€‚
      è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
      è«‹å‹™å¿…æä¾›æ¯æ—¥é›¨é‡(æ¯«ç±³)ã€é›¨æ°´pHå€¼ã€æ¯æ—¥ç´«å¤–ç·šæŒ‡æ•¸ã€‚å¦‚æœè³‡æ–™ç„¡æ³•å–å¾—ï¼Œè«‹ä½¿ç”¨ 0 æˆ–ä¸€å€‹åˆç†çš„é è¨­å€¼ã€‚
      åƒ…ä»¥ JSON ç‰©ä»¶å›æ‡‰ã€‚è©² JSON ç‰©ä»¶æ‡‰å…·æœ‰ä»¥ä¸‹ç¢ºåˆ‡çµæ§‹ï¼Œå¦‚æœæ²’æœ‰è­¦å ±ï¼Œè«‹å›å‚³ä¸€å€‹ç©ºçš„ "alerts" é™£åˆ—ï¼š
      {
        "city": "åŸå¸‚åç¨±",
        "current": {
          "temp_c": number,
          "condition": "å¤©æ°£ç‹€æ³",
          "humidity": number,
          "wind_kph": number,
          "feelslike_c": number,
          "uv": number,
          "wind_dir": "é¢¨å‘ (ä¾‹å¦‚ï¼šæ±åŒ—é¢¨)"
        },
        "forecast": [
          {
            "date": "YYYY-MM-DD",
            "day": {
              "maxtemp_c": number,
              "mintemp_c": number,
              "condition": "å¤©æ°£ç‹€æ³",
              "daily_chance_of_rain": number,
              "daily_rainfall_mm": number,
              "rain_ph": number,
              "daily_uv_index": number
            }
          }
        ],
        "alerts": [
          {
            "headline": "è­¦å ±æ¨™é¡Œ",
            "description": "è­¦å ±è©³ç´°èªªæ˜"
          }
        ]
      }
    `;

    try {
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash-preview-04-17',
        contents: prompt,
        config: {
          responseMimeType: 'application/json',
        },
      });

      let jsonStr = response.text.trim();
      const fenceRegex = /^```(\w*)?\s*\n?(.*?)\n?\s*```$/s;
      const match = jsonStr.match(fenceRegex);
      if (match && match[2]) {
        jsonStr = match[2].trim();
      }
      
      const data: WeatherData = JSON.parse(jsonStr);
      setWeatherData(data);

    } catch (e) {
      console.error('API éŒ¯èª¤:', e);
      setError('ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™ã€‚è«‹æª¢æŸ¥åŸå¸‚åç¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚');
    } finally {
      setLoading(false);
    }
  };

  const getAirQualityData = async () => {
    if (!city) {
      setAirQualityError('è«‹è¼¸å…¥åŸå¸‚åç¨±ã€‚');
      return;
    }
    setAirQualityLoading(true);
    setAirQualityError(null);
    setAirQualityData(null);

    const prompt = `
      æ ¹æ“šå°ç£ã€Œè¡Œæ”¿é™¢ç’°ä¿ç½²ç©ºæ°£å“è³ªç›£æ¸¬ç¶²ã€çš„å…¬é–‹è³‡æ–™ï¼Œæä¾› ${city} çš„å³æ™‚ç©ºæ°£å“è³ªè³‡è¨Šã€‚
      è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
      è«‹åŒ…å« AQI æŒ‡æ•¸ã€ç­‰ç´šï¼ˆä¾‹å¦‚ï¼šè‰¯å¥½, æ™®é€š, å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·, å°æ‰€æœ‰æ—ç¾¤ä¸å¥åº·, éå¸¸ä¸å¥åº·, å±å®³ï¼‰ã€ä¸»è¦æ±¡æŸ“ç‰©æ¿ƒåº¦ï¼ˆPM2.5, PM10, O3, NO2, SO2, COï¼‰ï¼Œä»¥åŠåŸºæ–¼ AQI ç­‰ç´šçš„å¥åº·å»ºè­°ã€‚
      åƒ…ä»¥ JSON ç‰©ä»¶å›æ‡‰ã€‚è©² JSON ç‰©ä»¶æ‡‰å…·æœ‰ä»¥ä¸‹ç¢ºåˆ‡çµæ§‹ï¼š
      {
        "city": "åŸå¸‚åç¨±",
        "aqi": number,
        "level": "ç­‰ç´š",
        "pollutants": {
          "pm25": number,
          "pm10": number,
          "o3": number,
          "no2": number,
          "so2": number,
          "co": number
        },
        "health_recommendation": "å¥åº·å»ºè­°æ–‡å­—"
      }
    `;

    try {
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash-preview-04-17',
        contents: prompt,
        config: {
          responseMimeType: 'application/json',
        },
      });
      let jsonStr = response.text.trim();
      const fenceRegex = /^```(\w*)?\s*\n?(.*?)\n?\s*```$/s;
      const match = jsonStr.match(fenceRegex);
      if (match && match[2]) {
        jsonStr = match[2].trim();
      }
      const data: AirQualityData = JSON.parse(jsonStr);
      setAirQualityData(data);
    } catch (e) {
      console.error('API éŒ¯èª¤ (ç©ºæ°£å“è³ª):', e);
      setAirQualityError('ç„¡æ³•å–å¾—ç©ºæ°£å“è³ªè³‡æ–™ã€‚è«‹æª¢æŸ¥åŸå¸‚åç¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚');
    } finally {
      setAirQualityLoading(false);
    }
  };


  const getDetailedData = async () => {
    if (!city) {
      setDataError('è«‹è¼¸å…¥åŸå¸‚åç¨±ã€‚');
      return;
    }
    setDataLoading(true);
    setDataError(null);
    setDetailedData(null);

    const prompt = `
      æ ¹æ“šå°ç£ä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™ï¼Œæä¾› ${city} æœ€è¿‘7å¤©çš„æ¯æ—¥é›¨é‡(æ¯«ç±³)ã€é›¨æ°´pHå€¼ã€æ¯æ—¥ç´«å¤–ç·šæŒ‡æ•¸ã€‚
      è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
      å¦‚æœæŸé …è³‡æ–™ç„¡æ³•å–å¾—ï¼ˆä¾‹å¦‚æ²’æœ‰ä¸‹é›¨å°±æ²’æœ‰pHå€¼ï¼‰ï¼Œè«‹ç‚º rain_ph ä½¿ç”¨ nullã€‚
      åƒ…ä»¥ JSON ç‰©ä»¶å›æ‡‰ã€‚è©² JSON ç‰©ä»¶æ‡‰å…·æœ‰ä»¥ä¸‹ç¢ºåˆ‡çµæ§‹ï¼š
      {
        "city": "åŸå¸‚åç¨±",
        "dailyData": [
          {
            "date": "YYYY-MM-DD",
            "rainfall_mm": number,
            "rain_ph": number | null,
            "uv_index": number
          }
        ]
      }
    `;

    try {
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash-preview-04-17',
        contents: prompt,
        config: {
          responseMimeType: 'application/json',
        },
      });
      let jsonStr = response.text.trim();
      const fenceRegex = /^```(\w*)?\s*\n?(.*?)\n?\s*```$/s;
      const match = jsonStr.match(fenceRegex);
      if (match && match[2]) {
        jsonStr = match[2].trim();
      }
      const data: DetailedData = JSON.parse(jsonStr);
      setDetailedData(data);
    } catch (e) {
      console.error('API éŒ¯èª¤ (è©³ç´°è³‡æ–™):', e);
      setDataError('ç„¡æ³•å–å¾—è©³ç´°è³‡æ–™ã€‚è«‹æª¢æŸ¥åŸå¸‚åç¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚');
    } finally {
      setDataLoading(false);
    }
  };

  const getAstroFact = async () => {
    setAstroLoading(true);
    setAstroError(null);
    const prompt = 'è«‹æ ¹æ“šå°ç£ä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™æˆ–ç¶²ç«™å…§å®¹ï¼Œç”¨ç¹é«”ä¸­æ–‡æä¾›ä¸€å‰‡é—œæ–¼å¤©æ–‡å­¸æˆ–å¤§æ°£ç§‘å­¸çš„æœ‰è¶£å°çŸ¥è­˜ã€‚å…§å®¹éœ€ç°¡æ½”ã€æ˜“æ–¼ç†è§£ï¼Œå¤§ç´„ 100 å­—ã€‚';
    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash-preview-04-17',
            contents: prompt,
        });
        setAstroFact(response.text);
    } catch (e) {
        console.error('Astro API éŒ¯èª¤:', e);
        setAstroError('ç„¡æ³•å–å¾—å¤©æ–‡çŸ¥è­˜ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    } finally {
        setAstroLoading(false);
    }
  };

  const getLifeData = async (category: string) => {
    if (!city) {
      setLifeError('è«‹å…ˆåœ¨ä»»ä¸€åˆ†é è¼¸å…¥åŸå¸‚åç¨±ã€‚');
      setLifeData('');
      setLifeLoading(false);
      return;
    }
    setLifeLoading(true);
    setLifeError(null);
    setLifeData('');

    const prompt = `
      ä½ æ˜¯ä¸€å€‹ç”Ÿæ´»æ°£è±¡å°å¹«æ‰‹ã€‚æ ¹æ“šå°ç£ä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™ï¼Œç‚ºã€Œ${city}ã€æä¾›é—œæ–¼ã€Œ${category}ã€ä¸»é¡Œçš„ç”Ÿæ´»æ°£è±¡å»ºè­°å’Œç›¸é—œè³‡è¨Šã€‚
      ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯ç™»å±±ï¼Œè«‹æä¾›å¤©æ°£ã€æ­¥é“å»ºè­°ã€æ³¨æ„äº‹é …ã€‚å¦‚æœæ˜¯è§€æ˜Ÿï¼Œè«‹æä¾›å¤©æ°£ã€å…‰å®³ã€èƒ½è¦‹åº¦ç­‰å»ºè­°ã€‚
      è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œå…§å®¹è¦å¯¦ç”¨ã€æ¢ç†åˆ†æ˜ï¼Œä¸¦ä¸”æ ¼å¼åŒ–æˆæ˜“æ–¼é–±è®€çš„æ®µè½ã€‚
    `;
    try {
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash-preview-04-17',
        contents: prompt,
      });
      setLifeData(response.text);
    } catch (e) {
      console.error('API éŒ¯èª¤ (ç”Ÿæ´»è³‡è¨Š):', e);
      setLifeError(`ç„¡æ³•å–å¾—ã€Œ${category}ã€çš„è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`);
    } finally {
      setLifeLoading(false);
    }
  };

  const getEarthquakeData = async (category: string) => {
    setEarthquakeLoading(true);
    setEarthquakeError(null);
    setEarthquakeData('');

    const locationContext = (category === 'è¿‘åœ°éœ‡' || category === 'ç½å®³åœ°éœ‡') && city ? `ï¼Œç‰¹åˆ¥æ˜¯èˆ‡ ${city} ç›¸é—œçš„è³‡è¨Š` : '';

    const prompt = `
      ä½ æ˜¯ä¸€å€‹åœ°éœ‡è³‡è¨Šå°ˆå®¶ã€‚æ ¹æ“šå°ç£ä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™ï¼Œæä¾›é—œæ–¼ã€Œ${category}ã€ä¸»é¡Œçš„è©³ç´°è³‡è¨Š${locationContext}ã€‚
      - å¦‚æœæ˜¯ã€Œè¿‘åœ°éœ‡ã€ï¼Œæä¾›æœ€è¿‘åœ¨å°ç£é™„è¿‘ç™¼ç”Ÿçš„åœ°éœ‡åˆ—è¡¨ã€‚
      - å¦‚æœæ˜¯ã€Œå…¨çƒåœ°éœ‡ã€ï¼Œæä¾›æœ€è¿‘å…¨çƒç¯„åœå…§çš„é¡¯è‘—åœ°éœ‡ã€‚
      - å¦‚æœæ˜¯ã€Œåœ°éœ‡æ´»å‹•å½™æ•´ã€ï¼Œæä¾›è¿‘æœŸåœ°éœ‡æ´»å‹•çš„çµ±è¨ˆèˆ‡åˆ†æã€‚
      - å¦‚æœæ˜¯ã€Œåœ°éœ‡ç™¾å•ã€ï¼Œé¸æ“‡ä¸€å€‹å¸¸è¦‹å•é¡Œä¸¦æä¾›è©³ç´°è§£ç­”ã€‚
      - å¦‚æœæ˜¯ã€Œåœ°éœ‡é˜²è­·ã€ï¼Œæä¾›å¯¦ç”¨çš„åœ°éœ‡é˜²ç½æº–å‚™èˆ‡æ‡‰è®Šæªæ–½ã€‚
      - å¦‚æœæ˜¯ã€Œåœ°éœ‡è§€æ¸¬ç¶²ã€ï¼Œä»‹ç´¹å…¶åŠŸèƒ½èˆ‡é‡è¦æ€§ã€‚
      - å¦‚æœæ˜¯ã€Œç½å®³åœ°éœ‡ã€ï¼Œå›é¡§ä¸€æ¬¡å°ç£æ­·å²ä¸Šçš„ç½å®³æ€§åœ°éœ‡äº‹ä»¶ã€‚
      - å¦‚æœæ˜¯ã€Œåœ°éœ‡è©±é¡Œã€ï¼Œè¨è«–ä¸€å€‹è¿‘æœŸæœ‰é—œåœ°éœ‡çš„ç†±é–€è©±é¡Œã€‚
      è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œå…§å®¹è¦å°ˆæ¥­ã€æ¢ç†åˆ†æ˜ï¼Œä¸¦ä¸”æ ¼å¼åŒ–æˆæ˜“æ–¼é–±è®€çš„æ®µè½æˆ–åˆ—è¡¨ã€‚
    `;
    try {
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash-preview-04-17',
        contents: prompt,
      });
      setEarthquakeData(response.text);
    } catch (e) {
      console.error('API éŒ¯èª¤ (åœ°éœ‡è³‡è¨Š):', e);
      setEarthquakeError(`ç„¡æ³•å–å¾—ã€Œ${category}ã€çš„è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`);
    } finally {
      setEarthquakeLoading(false);
    }
  };

  const getTyphoonData = async () => {
    setTyphoonLoading(true);
    setTyphoonError(null);
    setTyphoonData(null);
    setTyphoonSources([]);

    const prompt = `
      ä½¿ç”¨ Google Search çš„æœ€æ–°è³‡è¨Šï¼Œä¸¦åƒè€ƒå°ç£ä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™ï¼Œæä¾›ç•¶å‰æ‰€æœ‰æ­£åœ¨å½±éŸ¿æˆ–æœªä¾†48å°æ™‚å…§å¯èƒ½å½±éŸ¿å°ç£çš„æ´»èºé¢±é¢¨çš„æœ€æ–°å‹•æ…‹ã€‚
      å¦‚æœç›®å‰æ²’æœ‰æ´»èºæˆ–æ½›åœ¨å¨è„…çš„é¢±é¢¨ï¼Œè«‹å›å‚³ä¸€å€‹ç©ºçš„ JSON é™£åˆ—ã€‚
      è«‹ç‚ºæ¯å€‹é¢±é¢¨æä¾›ä»¥ä¸‹è³‡è¨Šï¼šé¢±é¢¨åç¨±ï¼ˆä¸­æ–‡ï¼‰ã€è‹±æ–‡åç¨±ã€æ˜¯å¦æ´»èº (å›ºå®šç‚º true)ã€ä¸­å¿ƒä½ç½®æè¿°ã€ä¸­å¿ƒæœ€å¤§é¢¨é€Ÿï¼ˆå…¬é‡Œ/å°æ™‚ï¼‰ã€ä¸ƒç´šé¢¨æš´é¢¨åŠå¾‘ï¼ˆå…¬é‡Œï¼‰ã€ç§»å‹•æ–¹å‘èˆ‡é€Ÿåº¦ï¼ˆä¾‹å¦‚ï¼šæ¯å°æ™‚20å…¬é‡Œï¼Œå‘è¥¿ç§»å‹•ï¼‰ã€ä»¥åŠå°å°ç£çš„ç¶œåˆå½±éŸ¿è©•ä¼°æ‘˜è¦ã€‚
      åƒ…ä»¥ JSON ç‰©ä»¶å›æ‡‰ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ ¼å¼ã€‚è©² JSON ç‰©ä»¶æ‡‰å…·æœ‰ä»¥ä¸‹ç¢ºåˆ‡çµæ§‹ï¼š
      [
        {
          "name": "string",
          "englishName": "string",
          "isActive": true,
          "location": "string",
          "maxWindSpeed_kph": number,
          "stormRadius_km": number,
          "movement": "string",
          "summary": "string"
        }
      ]
    `;

    try {
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash-preview-04-17',
        contents: prompt,
        config: {
          tools: [{ googleSearch: {} }],
        },
      });
      let jsonStr = response.text.trim();
      const fenceRegex = /^```(\w*)?\s*\n?(.*?)\n?\s*```$/s;
      const match = jsonStr.match(fenceRegex);
      if (match && match[2]) {
        jsonStr = match[2].trim();
      }
      const data: TyphoonInfo[] = JSON.parse(jsonStr);
      setTyphoonData(data);
      
      const sources = response.candidates?.[0]?.groundingMetadata?.groundingChunks ?? [];
      setTyphoonSources(sources.filter(chunk => chunk.web && chunk.web.uri));

    } catch (e) {
      console.error('API éŒ¯èª¤ (é¢±é¢¨å‹•æ…‹):', e);
      setTyphoonError('ç„¡æ³•å–å¾—é¢±é¢¨å‹•æ…‹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚é€™å¯èƒ½æ˜¯æš«æ™‚æ€§å•é¡Œæˆ–ç›®å‰æ²’æœ‰å¯ç”¨çš„å…¬é–‹è³‡è¨Šã€‚');
    } finally {
      setTyphoonLoading(false);
    }
  };

  const handleLifeCategoryClick = (category: string) => {
    setSelectedLifeCategory(category);
    setIsLifeModalOpen(true);
    getLifeData(category);
  };

  const handleEarthquakeCategoryClick = (category: string) => {
    setSelectedEarthquakeCategory(category);
    setIsEarthquakeModalOpen(true);
    getEarthquakeData(category);
  };

  useEffect(() => {
    if (activeTab === 'å¤©æ°£' && !weatherData && !loading && !error) {
        getWeatherData();
    }
     if (activeTab === 'ç©ºæ°£å“è³ª' && !airQualityData && !airQualityLoading && !airQualityError) {
        getAirQualityData();
    }
    if (activeTab === 'çŸ¥è­˜èˆ‡å¤©æ–‡' && !astroFact && !astroLoading && !astroError) {
        getAstroFact();
    }
    if (activeTab === 'é¢±é¢¨å‹•æ…‹' && !typhoonData && !typhoonLoading && !typhoonError) {
        getTyphoonData();
    }
  }, [activeTab]);


  const getWeatherIcon = (condition: string): string => {
    const lowerCaseCondition = condition.toLowerCase();
    if (lowerCaseCondition.includes('é›·')) return 'â›ˆï¸';
    if (lowerCaseCondition.includes('é›¨') || lowerCaseCondition.includes('æ¯›æ¯›é›¨')) return 'ğŸŒ§ï¸';
    if (lowerCaseCondition.includes('é›ª') || lowerCaseCondition.includes('é›¨å¤¾é›ª') || lowerCaseCondition.includes('æš´é¢¨é›ª')) return 'â„ï¸';
    if (lowerCaseCondition.includes('æ™´')) return 'â˜€ï¸';
    if (lowerCaseCondition.includes('é›²') || lowerCaseCondition.includes('é™°')) return 'â˜ï¸';
    if (lowerCaseCondition.includes('éœ§')) return 'ğŸŒ«ï¸';
    return 'â›…'; // é è¨­
  };

  const getDayOfWeek = (dateString: string) => {
    const date = new Date(dateString);
    date.setUTCHours(12); // èª¿æ•´ä»¥é¿å…æ™‚å€å•é¡Œ
    return date.toLocaleDateString('zh-TW', { weekday: 'short' });
  };
  
  const getWindDirectionRotation = (windDir: string): number => {
    if (!windDir) return 0;
    if (windDir.includes('æ±åŒ—')) return 45;
    if (windDir.includes('æ±å—')) return 135;
    if (windDir.includes('è¥¿å—')) return 225;
    if (windDir.includes('è¥¿åŒ—')) return 315;
    if (windDir.includes('åŒ—')) return 0;
    if (windDir.includes('æ±')) return 90;
    if (windDir.includes('å—')) return 180;
    if (windDir.includes('è¥¿')) return 270;
    return 0; // é è¨­ç‚ºéœæ­¢æˆ–ç„¡é¢¨å‘
  };

  const getAqiClass = (aqi: number): string => {
    if (aqi <= 50) return 'aqi-good';
    if (aqi <= 100) return 'aqi-moderate';
    if (aqi <= 150) return 'aqi-unhealthy-sensitive';
    if (aqi <= 200) return 'aqi-unhealthy';
    if (aqi <= 300) return 'aqi-very-unhealthy';
    return 'aqi-hazardous';
  };


  const renderContent = () => {
    switch (activeTab) {
      case 'å¤©æ°£':
        return (
          <>
            <div className="search-box">
              <input
                type="text"
                value={city}
                onChange={(e) => setCity(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && getWeatherData()}
                placeholder="ä¾‹å¦‚ï¼šå°åŒ—"
                aria-label="åŸå¸‚åç¨±"
              />
              <button onClick={getWeatherData} disabled={loading}>
                {loading ? 'æœå°‹ä¸­...' : 'å–å¾—å¤©æ°£'}
              </button>
            </div>

            {error && <div className="error-message weather-error" role="alert">{error}</div>}
            {loading && <div className="loading-spinner" aria-label="æ­£åœ¨è¼‰å…¥å¤©æ°£è³‡æ–™"></div>}

            {weatherData && (
              <div className="weather-container">
                {weatherData.alerts && weatherData.alerts.length > 0 && (
                    <div className="weather-alerts" role="alert">
                        {weatherData.alerts.map((alert, index) => (
                            <div key={index} className="alert-item">
                                <h4><span className="alert-icon">âš ï¸</span> {alert.headline}</h4>
                                <p>{alert.description}</p>
                            </div>
                        ))}
                    </div>
                )}
                <div className="weather-results" role="region" aria-live="polite">
                    <div className="current-weather">
                        <h2>{weatherData.city}</h2>
                        <div className="current-weather-details">
                            <div className="current-temp">
                                <span className="weather-icon">{getWeatherIcon(weatherData.current.condition)}</span>
                                {Math.round(weatherData.current.temp_c)}Â°C
                            </div>
                            <div className="current-condition">{weatherData.current.condition}</div>
                        </div>

                        {weatherData.current.wind_dir && (
                          <div className="wind-display">
                            <div className="wind-compass">
                              <span className="north">N</span>
                              <span className="east">E</span>
                              <span className="south">S</span>
                              <span className="west">W</span>
                              <div
                                className="wind-arrow"
                                style={{ transform: `rotate(${getWindDirectionRotation(weatherData.current.wind_dir)}deg)` }}
                                title={`é¢¨å‘: ${weatherData.current.wind_dir}`}
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                  <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path>
                                </svg>
                              </div>
                            </div>
                            <div className="wind-info">
                              <div className="wind-label">é¢¨åŠ›</div>
                              <div className="wind-speed">{weatherData.current.wind_kph}<span> kph</span></div>
                              <div className="wind-direction">{weatherData.current.wind_dir}</div>
                            </div>
                          </div>
                        )}

                        <div className="current-extras">
                            <div className="extra-item"><span>é«”æ„Ÿ</span><strong>{Math.round(weatherData.current.feelslike_c)}Â°</strong></div>
                            <div className="extra-item"><span>æ¿•åº¦</span><strong>{weatherData.current.humidity}%</strong></div>
                            <div className="extra-item"><span>ç´«å¤–ç·š</span><strong>{weatherData.current.uv}</strong></div>
                        </div>
                    </div>
                    <div className="forecast">
                      <h3>5 å¤©å¤©æ°£é å ±</h3>
                      <div className="forecast-grid">
                          {weatherData.forecast.slice(0, 5).map((day) => (
                          <div className="forecast-day" key={day.date}>
                              <h4>{getDayOfWeek(day.date)}</h4>
                              <span className="weather-icon">{getWeatherIcon(day.day.condition)}</span>
                              <div className="forecast-temps">
                                <strong>{Math.round(day.day.maxtemp_c)}Â°</strong>
                                <span>{Math.round(day.day.mintemp_c)}Â°</span>
                              </div>
                              <div className="precip"><span className="precip-icon">ğŸ’§</span>{day.day.daily_chance_of_rain}%</div>
                              <div className="forecast-details">
                                <div className="forecast-detail-item" title="æ¯æ—¥é›¨é‡"><span className="detail-icon">ğŸŒ§ï¸</span><span className="detail-value">{day.day.daily_rainfall_mm} mm</span></div>
                                <div className="forecast-detail-item" title="æ¯æ—¥ç´«å¤–ç·š"><span className="detail-icon">â˜€ï¸</span><span className="detail-value">æŒ‡æ•¸ {day.day.daily_uv_index}</span></div>
                                <div className="forecast-detail-item" title="é›¨æ°´pHå€¼"><span className="detail-icon">ğŸ§ª</span><span className="detail-value">pH {day.day.rain_ph}</span></div>
                              </div>
                          </div>
                          ))}
                      </div>
                    </div>
                    <div className="data-source">è³‡æ–™ä¾†æºï¼šäº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½² (é€é Gemini API å½™æ•´)</div>
                </div>
              </div>
            )}
          </>
        );

      case 'ç©ºæ°£å“è³ª':
        return (
            <div className="air-quality-content">
                <h3>å³æ™‚ç©ºæ°£å“è³ª</h3>
                <div className="search-box">
                    <input
                        type="text"
                        value={city}
                        onChange={(e) => setCity(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && getAirQualityData()}
                        placeholder="ä¾‹å¦‚ï¼šå°åŒ—"
                        aria-label="åŸå¸‚åç¨±"
                    />
                    <button onClick={getAirQualityData} disabled={airQualityLoading}>
                        {airQualityLoading ? 'æŸ¥è©¢ä¸­...' : 'æŸ¥è©¢ç©ºå“'}
                    </button>
                </div>

                {airQualityError && <div className="error-message" role="alert">{airQualityError}</div>}
                {airQualityLoading && <div className="loading-spinner" aria-label="æ­£åœ¨è¼‰å…¥ç©ºæ°£å“è³ªè³‡æ–™"></div>}

                {airQualityData && (
                    <div className="aq-results">
                        <h4>{airQualityData.city}</h4>
                        <div className="aqi-display-wrapper">
                            <div className={`aqi-display ${getAqiClass(airQualityData.aqi)}`}>
                                <div className="aqi-value">{airQualityData.aqi}</div>
                                <div className="aqi-label">AQI</div>
                            </div>
                            <div className="aqi-level">{airQualityData.level}</div>
                        </div>

                        <div className="pollutants-grid">
                            <div className="pollutant-item"><span>PM2.5</span><strong>{airQualityData.pollutants.pm25}</strong></div>
                            <div className="pollutant-item"><span>PM10</span><strong>{airQualityData.pollutants.pm10}</strong></div>
                            <div className="pollutant-item"><span>Oâ‚ƒ</span><strong>{airQualityData.pollutants.o3}</strong></div>
                            <div className="pollutant-item"><span>NOâ‚‚</span><strong>{airQualityData.pollutants.no2}</strong></div>
                            <div className="pollutant-item"><span>SOâ‚‚</span><strong>{airQualityData.pollutants.so2}</strong></div>
                            <div className="pollutant-item"><span>CO</span><strong>{airQualityData.pollutants.co}</strong></div>
                        </div>

                        <div className="health-recommendation">
                            <h5><span className="rec-icon">ğŸ’¡</span> å¥åº·å»ºè­°</h5>
                            <p>{airQualityData.health_recommendation}</p>
                        </div>

                        <div className="data-source">
                            è³‡æ–™ä¾†æºï¼šè¡Œæ”¿é™¢ç’°ä¿ç½² - ç©ºæ°£å“è³ªç›£æ¸¬ç¶² (é€é Gemini API å½™æ•´)
                        </div>
                    </div>
                )}
            </div>
        );

      case 'ç”Ÿæ´»':
        return (
          <div className="life-content">
            <h3>ç”Ÿæ´»æŒ‡æ•¸èˆ‡æ—…éŠæ°£è±¡</h3>
            <p className="life-subtitle">é¸æ“‡ä¸€å€‹åˆ†é¡ï¼ŒæŸ¥çœ‹ {city} çš„ç›¸é—œç”Ÿæ´»æ°£è±¡å»ºè­°ã€‚</p>
            <div className="life-grid">
              {lifeCategories.map(category => (
                <button 
                  key={category.name} 
                  className="life-card"
                  onClick={() => handleLifeCategoryClick(category.name)}
                >
                  <span className="life-card-icon">{category.icon}</span>
                  <span className="life-card-name">{category.name}</span>
                </button>
              ))}
            </div>
            {isLifeModalOpen && (
              <div className="modal-overlay" onClick={() => setIsLifeModalOpen(false)}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                  <div className="modal-header">
                    <h4>{city} - {selectedLifeCategory}</h4>
                    <button className="modal-close-btn" onClick={() => setIsLifeModalOpen(false)}>&times;</button>
                  </div>
                  <div className="modal-body">
                    {lifeLoading && <div className="loading-spinner" aria-label="æ­£åœ¨è¼‰å…¥è³‡æ–™"></div>}
                    {lifeError && <div className="error-message" role="alert">{lifeError}</div>}
                    {lifeData && !lifeLoading && !lifeError && (
                      <>
                        <div className="life-data-content">{lifeData}</div>
                        <div className="data-source">
                          è³‡æ–™ä¾†æºï¼šäº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½² (é€é Gemini API å½™æ•´)
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        );

      case 'åœ°éœ‡':
        return (
          <div className="earthquake-content">
            <h3>åœ°éœ‡è³‡è¨Šèˆ‡çŸ¥è­˜</h3>
            <p className="earthquake-subtitle">é¸æ“‡ä¸€å€‹åˆ†é¡ï¼ŒæŸ¥çœ‹ç”±ä¸­å¤®æ°£è±¡ç½²æä¾›çš„ç›¸é—œåœ°éœ‡è³‡è¨Šã€‚</p>
            <div className="earthquake-grid">
              {earthquakeCategories.map(category => (
                <button
                  key={category.name}
                  className="earthquake-card"
                  onClick={() => handleEarthquakeCategoryClick(category.name)}
                >
                  <span className="earthquake-card-icon">{category.icon}</span>
                  <span className="earthquake-card-name">{category.name}</span>
                </button>
              ))}
            </div>
            {isEarthquakeModalOpen && (
              <div className="modal-overlay" onClick={() => setIsEarthquakeModalOpen(false)}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                  <div className="modal-header">
                    <h4>{selectedEarthquakeCategory}</h4>
                    <button className="modal-close-btn" onClick={() => setIsEarthquakeModalOpen(false)}>&times;</button>
                  </div>
                  <div className="modal-body">
                    {earthquakeLoading && <div className="loading-spinner" aria-label="æ­£åœ¨è¼‰å…¥è³‡æ–™"></div>}
                    {earthquakeError && <div className="error-message" role="alert">{earthquakeError}</div>}
                    {earthquakeData && !earthquakeLoading && !earthquakeError && (
                      <>
                        <div className="earthquake-data-content">{earthquakeData}</div>
                        <div className="data-source">
                          è³‡æ–™ä¾†æºï¼šäº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½² (é€é Gemini API å½™æ•´)
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      
      case 'é¢±é¢¨å‹•æ…‹':
        return (
          <div className="typhoon-content">
            <h3>é¢±é¢¨å‹•æ…‹</h3>

            <div className="typhoon-map-container">
              <iframe
                width="100%"
                height="100%"
                src="https://embed.windy.com/embed.html?lat=23.9&lon=121.5&zoom=7&level=surface&overlay=wind&menu=&message=true&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1"
                frameBorder="0"
                title="Windy.com Typhoon Map"
                aria-label="Windy.com é¢±é¢¨å‹•æ…‹åœ°åœ–"
              ></iframe>
            </div>

            {typhoonData && typhoonData.length > 0 && (
              <div className="active-typhoon-summary">
                ç›®å‰æ´»èºé¢±é¢¨ï¼š{typhoonData.map(t => t.name).join('ã€')}
              </div>
            )}

            {typhoonLoading && <div className="loading-spinner" aria-label="æ­£åœ¨è¼‰å…¥é¢±é¢¨å‹•æ…‹"></div>}
            {typhoonError && <div className="error-message" role="alert">{typhoonError}</div>}
            
            {typhoonData && (
              <>
                {typhoonData.length === 0 ? (
                  <div className="no-typhoon-message">
                    <span className="no-typhoon-icon">ğŸ’¨</span>
                    <h4>ç›®å‰å°šç„¡å½±éŸ¿å°ç£çš„é¢±é¢¨</h4>
                    <p>ç›®å‰å¤©æ°£ç©©å®šï¼Œç„¡é¢±é¢¨æ´»å‹•è·¡è±¡ã€‚æˆ‘å€‘æœƒæŒçºŒç‚ºæ‚¨ç›£æ¸¬ã€‚</p>
                  </div>
                ) : (
                  <div className="typhoon-list">
                    {typhoonData.map((typhoon, index) => (
                      <div key={index} className="typhoon-card">
                        <div className="typhoon-header">
                          <span className="typhoon-icon">ğŸŒ€</span>
                          <div className="typhoon-names">
                            <h2>{typhoon.name}</h2>
                            <span>{typhoon.englishName}</span>
                          </div>
                        </div>
                        <div className="typhoon-stats">
                          <div className="stat-item"><strong>ä¸­å¿ƒä½ç½®:</strong> {typhoon.location}</div>
                          <div className="stat-item"><strong>æœ€å¤§é¢¨é€Ÿ:</strong> {typhoon.maxWindSpeed_kph} km/h</div>
                          <div className="stat-item"><strong>æš´é¢¨åŠå¾‘:</strong> {typhoon.stormRadius_km} km</div>
                          <div className="stat-item"><strong>ç§»å‹•è¶¨å‹¢:</strong> {typhoon.movement}</div>
                        </div>
                        <div className="typhoon-summary">
                          <h5>å½±éŸ¿è©•ä¼°</h5>
                          <p>{typhoon.summary}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                
                {typhoonSources.length > 0 && (
                  <div className="grounding-sources">
                    <h5>è³‡è¨Šä¾†æº</h5>
                    <ul>
                      {typhoonSources.map((source, index) => (
                        source.web && (
                          <li key={index}>
                            <a href={source.web.uri} target="_blank" rel="noopener noreferrer">
                              {source.web.title || source.web.uri}
                            </a>
                          </li>
                        )
                      ))}
                    </ul>
                  </div>
                )}

                <div className="data-source">è³‡æ–™ä¾†æºï¼šäº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½², Windy.com & Google Search (é€é Gemini API å½™æ•´)</div>
              </>
            )}
          </div>
        );

      case 'è³‡æ–™':
        return (
          <div className="data-content">
              <h3>è©³ç´°æ°£è±¡è³‡æ–™</h3>
              <div className="search-box">
                  <input
                      type="text"
                      value={city}
                      onChange={(e) => setCity(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && getDetailedData()}
                      placeholder="ä¾‹å¦‚ï¼šå°åŒ—"
                      aria-label="åŸå¸‚åç¨±"
                  />
                  <button onClick={getDetailedData} disabled={dataLoading}>
                      {dataLoading ? 'æŸ¥è©¢ä¸­...' : 'æŸ¥è©¢è³‡æ–™'}
                  </button>
              </div>

              {dataError && <div className="error-message" role="alert">{dataError}</div>}
              {dataLoading && <div className="loading-spinner" aria-label="æ­£åœ¨è¼‰å…¥è©³ç´°è³‡æ–™"></div>}

              {detailedData && (
                  <div className="data-results">
                      <h4>{detailedData.city} - æœ€è¿‘ 7 å¤©è³‡æ–™</h4>
                      <table className="data-table">
                          <thead>
                              <tr>
                                  <th>æ—¥æœŸ</th>
                                  <th>æ¯æ—¥é›¨é‡ (mm)</th>
                                  <th>é›¨æ°´ pH å€¼</th>
                                  <th>ç´«å¤–ç·šæŒ‡æ•¸</th>
                              </tr>
                          </thead>
                          <tbody>
                              {detailedData.dailyData.map(day => (
                                  <tr key={day.date}>
                                      <td>{day.date.split('-').slice(1).join('/')} ({getDayOfWeek(day.date)})</td>
                                      <td>{day.rainfall_mm}</td>
                                      <td>{day.rain_ph !== null ? day.rain_ph : 'N/A'}</td>
                                      <td>{day.uv_index}</td>
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                       <div className="data-source">
                          è³‡æ–™ä¾†æºï¼šäº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½² (é€é Gemini API å½™æ•´)
                      </div>
                  </div>
              )}
          </div>
        );

      case 'çŸ¥è­˜èˆ‡å¤©æ–‡':
        return (
            <div className="astro-content">
                <h3>å¤©æ–‡çŸ¥è­˜</h3>
                <div className="fact-card" aria-live="polite">
                    {astroLoading && <div className="loading-spinner" aria-label="æ­£åœ¨è¼‰å…¥å¤©æ–‡çŸ¥è­˜"></div>}
                    {astroError && <div className="error-message" role="alert">{astroError}</div>}
                    {astroFact && !astroLoading && !astroError && <p>{astroFact}</p>}
                </div>
                <button className="astro-button" onClick={getAstroFact} disabled={astroLoading}>
                    {astroLoading ? 'ç”¢ç”Ÿä¸­...' : 'ç”¢ç”Ÿæ–°çš„å¤©æ–‡çŸ¥è­˜'}
                </button>
                <div className="data-source">
                    è³‡æ–™ä¾†æºï¼šäº¤é€šéƒ¨ä¸­å¤®æ°£è±¡ç½² (é€é Gemini API å½™æ•´)
                </div>
            </div>
        );

      default:
        return (
          <div className="placeholder-content">
              <h3>{activeTab}</h3>
              <p>æ­¤åŠŸèƒ½å°‡æ•´åˆä¸­å¤®æ°£è±¡ç½²çš„å…¬é–‹è³‡æ–™ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
          </div>
        );
    }
  };

  return (
    <>
      <div className="container">
        <header>
          <h1>AI æ°£è±¡è³‡è¨Šç«™</h1>
          <p>æ‰€æœ‰å¤©æ°£è³‡æ–™å‡ä¾†è‡ªä¸­å¤®æ°£è±¡ç½²ï¼Œç”± Gemini API æ•´ç†å‘ˆç¾</p>
        </header>
        <nav className="main-nav">
            {navItems.map(item => (
              <button
                key={item}
                className={`nav-item ${activeTab === item ? 'active' : ''}`}
                onClick={() => setActiveTab(item)}
              >
                {item}
              </button>
            ))}
        </nav>
        <main>
          {renderContent()}
        </main>
      </div>

      <div className="chat-widget">
        <div className={`chat-window ${isChatOpen ? 'open' : ''}`}>
          <div className="chat-header">
            <h3>AI å°å¹«æ‰‹</h3>
            <button className="chat-close-btn" onClick={() => setIsChatOpen(false)}>&times;</button>
          </div>
          <div className="chat-messages" ref={chatMessagesRef}>
            {chatHistory.map((msg, index) => (
              <div key={index} className={`message-bubble-wrapper ${msg.role}-wrapper`}>
                <div className={`message-bubble ${msg.role}-message`}>{msg.text}</div>
              </div>
            ))}
            {isChatLoading && (
              <div className="message-bubble-wrapper model-wrapper">
                <div className="message-bubble model-message typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            )}
          </div>
          <form className="chat-input-form" onSubmit={handleSendMessage}>
            <input
              type="text"
              className="chat-input"
              value={chatInput}
              onChange={(e) => setChatInput(e.target.value)}
              placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."
              disabled={isChatLoading}
              aria-label="èŠå¤©è¼¸å…¥æ¡†"
            />
            <button type="submit" className="chat-send-btn" disabled={isChatLoading || !chatInput.trim()} aria-label="å‚³é€è¨Šæ¯">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </form>
        </div>
        <button className="chat-fab" onClick={() => setIsChatOpen(true)} aria-label="é–‹å•Ÿ AI èŠå¤©">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/></svg>
        </button>
      </div>
    </>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root')!);
root.render(<App />);
